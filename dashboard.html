<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üõ°Ô∏è CyberGuard ‚Äì Production v2.2</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root { --primary: #0d47a1; --safe: #2e7d32; --scam: #c62828; --suspicious: #f57f17; --pending: #6c757d; }
  body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; color: #333; }
  .container { max-width: 1200px; margin: 0 auto; }
  header { text-align: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  h1 { color: var(--primary); margin: 0; font-size: 2.2em; }
  .subtitle { color: #666; font-size: 1.1em; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .full-width { grid-column: 1 / -1; }
  label { display: block; font-weight: 600; margin-bottom: 8px; color: #444; }
  input, select, button, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
  button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: 600; transition: background 0.3s; }
  button:hover { background: #0b3d91; }
  button.secondary { background: #6c757d; }
  button.secondary:hover { background: #5a6268; }
  .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; color: white; font-weight: 700; font-size: 12px; margin-left: 10px; }
  .safe { background: var(--safe); } .scam { background: var(--scam); } .suspicious { background: var(--suspicious); } .pending { background: var(--pending); }
  .report-card { border-left: 4px solid #ddd; padding: 15px; margin-bottom: 15px; background: #fafafa; border-radius: 8px; }
  .report-card.safe { border-left-color: var(--safe); }
  .report-card.scam { border-left-color: var(--scam); }
  .report-card.suspicious { border-left-color: var(--suspicious); }
  #map { height: 400px; border-radius: 8px; margin-top: 10px; }
  .admin-actions { display: flex; gap: 8px; margin-top: 12px; }
  .admin-actions button { flex: 1; padding: 8px; font-size: 12px; }
  .confidence-bar { height: 6px; background: #e0e0e0; border-radius: 3px; margin: 8px 0; overflow: hidden; }
  .confidence-fill { height: 100%; transition: width 0.3s; }
  .risk-high { background: var(--scam); } .risk-medium { background: var(--suspicious); } .risk-low { background: var(--safe); }
  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
  .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .stat-number { font-size: 2em; font-weight: bold; color: var(--primary); }
  .stat-label { color: #666; font-size: 0.9em; }
  @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üõ°Ô∏è CyberGuard ‚Äì Production</h1>
      <div class="subtitle">Hybrid USSD/SMS Fraud Detection System</div>
    </header>

    <div class="stats" id="stats-container">
      <!-- Stats will be loaded dynamically -->
    </div>

    <div class="grid">
      <div class="card">
        <h3>üîß Configuration</h3>
        <label>Operation Mode</label>
        <select id="full-mode-select">
          <option value="false">üõ°Ô∏è Offline-First</option>
          <option value="true">üåê Full Hybrid</option>
        </select>
        
        <label>Admin Tools</label>
        <input id="sync-urls" placeholder="Trusted sources (URLs comma-separated)" />
        <button id="sync-btn">üîÑ Sync Safe Codes</button>
        <div id="sync-result" style="font-size: 12px; margin-top: 10px;"></div>
      </div>

      <div class="card">
        <h3>üìù Submit Report</h3>
        <label>Report Type</label>
        <select id="report-type">
          <option value="sms">üì® SMS Scam</option>
          <option value="ussd">üì± USSD Fraud</option>
        </select>
        
        <label>Content</label>
        <textarea id="report-content" placeholder="Paste suspicious content here..." rows="3"></textarea>
        
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <label>Location</label>
            <input id="report-location" placeholder="City" />
          </div>
          <div>
            <label>Username</label>
            <input id="report-username" placeholder="Optional" />
          </div>
        </div>
        
        <button id="submit-btn">üö® Submit Report</button>
        <div id="submit-result" style="font-size: 12px;"></div>
      </div>
    </div>

    <div class="card full-width">
      <h3>üìä Community Reports <span style="font-size: 0.8em; color: #666; font-weight: normal;">(Auto-refresh: 60s)</span></h3>
      <div id="report-feed"></div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>üó∫Ô∏è Threat Map</h3>
        <div id="map"></div>
      </div>
      
      <div class="card">
        <h3>‚ö° Quick Tests</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
          <button id="test-safe-ussd" class="secondary">‚úÖ Safe USSD</button>
          <button id="test-scam-sms" class="secondary">üö® Scam SMS</button>
          <button id="test-suspicious-ussd" class="secondary">‚ö†Ô∏è Suspicious USSD</button>
          <button id="health-check" class="secondary">‚ù§Ô∏è Health Check</button>
        </div>
        <pre id="test-result" style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 12px; max-height: 200px; overflow: auto; margin-top: 15px;">Run tests to see results...</pre>
      </div>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = ""; // Relative to current domain
const el = id => document.getElementById(id);

// Initialize map
let map = L.map('map').setView([9.0820, 8.6753], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
let markersLayer = L.layerGroup().addTo(map);

// Load stats
async function loadStats() {
  try {
    const health = await fetch(API + '/health').then(r => r.json());
    const reports = await fetch(API + '/community/reports').then(r => r.json());
    const stats = {
      healthy: health.status === 'healthy',
      online: health.online,
      reports: reports.reports?.length || 0,
      cache: health.cache_size || 0
    };
    
    el('stats-container').innerHTML = `
      <div class="stat-card">
        <div class="stat-number">${stats.healthy ? '‚úÖ' : '‚ùå'}</div>
        <div class="stat-label">Status</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${stats.online ? 'üåê' : 'üõ°Ô∏è'}</div>
        <div class="stat-label">Connection</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${stats.reports}</div>
        <div class="stat-label">Reports</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">${stats.cache}</div>
        <div class="stat-label">Cached</div>
      </div>
    `;
  } catch(e) {
    console.error('Stats load failed:', e);
  }
}

// Event listeners
el('submit-btn').addEventListener('click', submitReport);
el('sync-btn').addEventListener('click', syncUSSD);
el('test-safe-ussd').addEventListener('click', () => runTest('check-ussd?code=*123#&full_mode=true', 'Safe USSD Test'));
el('test-scam-sms').addEventListener('click', () => runTest('check-sms-scam?content=' + encodeURIComponent('You won $1M! Call 08012345678'), 'Scam SMS Test'));
el('test-suspicious-ussd').addEventListener('click', () => runTest('check-ussd?code=*635337467*2#&full_mode=false', 'Suspicious USSD Test'));
el('health-check').addEventListener('click', () => runTest('health', 'Health Check'));

// FIXED: Correct field names for API
async function submitReport() {
  const report = {
    report_type: el('report-type').value,  // FIXED: was 'type'
    content: el('report-content').value.trim(),
    location: el('report-location').value.trim(),
    username: el('report-username').value.trim() || 'Anonymous'
  };
  
  if (!report.content) return alert('Please enter content');
  
  try {
    const resp = await fetch(API + '/community/report', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(report)
    });
    
    if (!resp.ok) {
      const error = await resp.json();
      throw new Error(error.detail || `HTTP ${resp.status}`);
    }
    
    const result = await resp.json();
    el('submit-result').innerHTML = `<span style="color: green;">‚úÖ ${result.message}</span>`;
    el('report-content').value = '';
    el('report-location').value = '';
    el('report-username').value = '';
    await fetchFeed();
  } catch(e) {
    el('submit-result').innerHTML = `<span style="color: red;">‚ùå Submit failed: ${e.message}</span>`;
    console.error('Submit error:', e);
  }
}

async function syncUSSD() {
  const urls = el('sync-urls').value.trim();
  const urlList = urls ? urls.split(',').map(s => s.trim()).filter(Boolean) : null;
  
  try {
    const resp = await fetch(API + '/admin/sync-ussd', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({urls: urlList})
    });
    
    if (!resp.ok) {
      const error = await resp.json();
      throw new Error(error.detail || `HTTP ${resp.status}`);
    }
    
    const result = await resp.json();
    el('sync-result').innerHTML = `<span style="color: green;">‚úÖ ${result.message} (Total: ${result.total})</span>`;
  } catch(e) {
    el('sync-result').innerHTML = `<span style="color: red;">‚ùå Sync failed: ${e.message}</span>`;
  }
}

async function runTest(endpoint, name) {
  try {
    const resp = await fetch(API + '/' + endpoint);
    const result = await resp.json();
    el('test-result').innerText = `${name}:\n${JSON.stringify(result, null, 2)}`;
  } catch(e) {
    el('test-result').innerText = `${name} failed:\n${e}`;
  }
}

async function fetchFeed() {
  try {
    const [reportsResp, healthResp] = await Promise.all([
      fetch(API + '/community/reports'),
      fetch(API + '/health')
    ]);
    
    const data = await reportsResp.json();
    const health = await healthResp.json();
    
    // Update stats
    await loadStats();
    
    // Clear previous
    el('report-feed').innerHTML = '';
    map.removeLayer(markersLayer);
    markersLayer = L.layerGroup().addTo(map);
    
    // Process reports (newest first)
    const reports = (data.reports || []).slice().reverse();
    
    for(let report of reports) {
      const card = document.createElement('div');
      card.className = `report-card ${getReportStatus(report).toLowerCase()}`;
      
      // Get analysis
      let analysis = await analyzeContent(report);
      
      card.innerHTML = buildReportCard(report, analysis);
      el('report-feed').appendChild(card);
      
      // Add to map
      if (report.lat && report.lon) {
        addMapMarker(report, analysis);
      }
    }
  } catch(e) {
    console.error('Feed fetch failed:', e);
  }
}

async function analyzeContent(report) {
  try {
    if (report.report_type === 'sms') {
      const resp = await fetch(API + '/check-sms-scam?content=' + encodeURIComponent(report.content));
      return await resp.json();
    } else {
      const fullMode = el('full-mode-select').value === 'true';
      const resp = await fetch(API + '/check-ussd?code=' + encodeURIComponent(report.content) + '&full_mode=' + fullMode);
      return await resp.json();
    }
  } catch(e) {
    return null;
  }
}

function getReportStatus(report) {
  return report.status || 'pending';
}

function buildReportCard(report, analysis) {
  const status = analysis ? getAnalysisStatus(analysis, report.report_type) : 'pending';
  const badgeClass = status.toLowerCase();
  
  let html = `
    <div style="display: flex; justify-content: between; align-items: center;">
      <strong>${report.report_type.toUpperCase()}</strong>
      <span class="badge ${badgeClass}">${status}</span>
    </div>
    <div style="margin: 10px 0; font-size: 14px;">${report.content}</div>
    <div style="color: #666; font-size: 12px;">
      üìç ${report.location || 'Unknown'} ‚Ä¢ üë§ ${report.username} ‚Ä¢ üïí ${new Date(report.timestamp).toLocaleString()}
    </div>
  `;
  
  if (analysis) {
    html += buildAnalysisDetails(analysis, report.report_type);
  }
  
  html += buildAdminActions(report);
  
  return html;
}

function getAnalysisStatus(analysis, type) {
  if (type === 'sms') {
    return analysis.scam ? 'SCAM' : 'SAFE';
  } else {
    if (analysis.safe) return 'SAFE';
    if (analysis.score >= 8) return 'SCAM';
    if (analysis.score >= 5) return 'SUSPICIOUS';
    return 'SAFE';
  }
}

function buildAnalysisDetails(analysis, type) {
  const score = analysis.confidence || analysis.score || 0;
  const riskClass = score >= 8 ? 'risk-high' : (score >= 5 ? 'risk-medium' : 'risk-low');
  const width = Math.min(score * 10, 100) + '%';
  
  let details = `
    <div style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px; font-size: 13px;">
      <strong>Analysis:</strong>
      <div class="confidence-bar"><div class="confidence-fill ${riskClass}" style="width: ${width}"></div></div>
  `;
  
  if (type === 'ussd') {
    details += `Score: ${analysis.score}/10 ‚Ä¢ Safe: ${analysis.safe} ‚Ä¢ Online: ${analysis.verified_online || false}<br>`;
    details += `Reasons: ${(analysis.reasons || []).join('; ')}`;
  } else {
    details += `Scam: ${analysis.scam} ‚Ä¢ Confidence: ${score}/10<br>`;
    details += `Reasons: ${(analysis.reasons || []).join('; ')}`;
  }
  
  details += `</div>`;
  return details;
}

function buildAdminActions(report) {
  return `
    <div class="admin-actions">
      <button onclick="adminAction(${JSON.stringify(report).replace(/"/g, '&quot;')}, 'verify')">‚úÖ Verify</button>
      <button onclick="adminAction(${JSON.stringify(report).replace(/"/g, '&quot;')}, 'reject')" class="secondary">‚ùå Reject</button>
      ${report.report_type === 'ussd' ? `<button onclick="adminAction(${JSON.stringify(report).replace(/"/g, '&quot;')}, 'blacklist')" class="secondary">üö´ Blacklist</button>` : ''}
    </div>
  `;
}

function addMapMarker(report, analysis) {
  const status = analysis ? getAnalysisStatus(analysis, report.report_type) : 'pending';
  const color = status === 'SCAM' ? 'red' : (status === 'SUSPICIOUS' ? 'orange' : 'green');
  
  L.circleMarker([report.lat, report.lon], {
    color: color,
    fillColor: color,
    fillOpacity: 0.5,
    radius: 8
  })
  .bindPopup(`
    <strong>${report.report_type.toUpperCase()} - ${status}</strong><br>
    ${report.content}<br>
    <em>${report.location} ‚Ä¢ ${new Date(report.timestamp).toLocaleDateString()}</em>
  `)
  .addTo(markersLayer);
}

// FIXED: Correct admin action function
async function adminAction(report, action) {
  try {
    const allReports = await fetch(API + '/community/reports').then(r => r.json());
    const index = allReports.reports.findIndex(r => 
      r.timestamp === report.timestamp && r.content === report.content && r.username === report.username
    );
    
    if (index === -1) return alert('Report not found');
    
    const body = { 
      index: index, 
      status: action === 'verify' ? 'Verified' : (action === 'blacklist' ? 'Blacklisted' : 'Rejected')
    };
    
    if (action === 'verify') body.action = 'add_safe';
    if (action === 'blacklist') body.action = 'add_blacklist';
    
    const resp = await fetch(API + '/community/update-report', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    
    if (!resp.ok) {
      const error = await resp.json();
      throw new Error(error.detail);
    }
    
    const result = await resp.json();
    alert(`‚úÖ ${result.message}`);
    await fetchFeed();
  } catch(e) {
    alert(`‚ùå Action failed: ${e.message}`);
    console.error('Admin action error:', e);
  }
}

// Initialize
loadStats();
fetchFeed();
setInterval(fetchFeed, 60000); // 60 seconds
setInterval(loadStats, 30000); // 30 seconds
</script>
</body>
</html>
